<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="../dist/dygraph.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Follow Candlestick Legend - Test For Mobile Devices</title>

    <script type="text/javascript" src="../dist/dygraph.js"></script>
    <script type="text/javascript" src="./data.js"></script>
    <style>
      #legend {
        position: absolute;
        display: block;
        border: 1px solid #2f2f2f;
        background-color: #ffffff;
        opacity: 0.9;
        min-width: 150px;
      }
    </style>
  </head>
  <body>
    <h2>Legend Follow - Candlestick</h2>
    <p>Candlestick Chart with larger OHLVC dataset, and with a follow
      legend setting.</p> 
    <div id="candlechart" class="chart" style="width:100%; height:300px"></div>
    <div id="legend"></div>
    <script type="text/javascript">
      // The Candle chart plotter is adapted from code written by
      // Zhenlei Cai (jpenguin@gmail.com)
      // https://github.com/danvk/dygraphs/pull/141/files
      
      var BAR_WIDTH = 8;
      function candlePlotter(e) {
        // This is the officially endorsed way to plot all the series at once.
        if (e.seriesIndex !== 0) return;

        var setCount = e.seriesCount;
        if (setCount != 4) {
          throw "Exactly 4 prices each point must be provided for candle chart (open close high low)";
        }

        var prices = [];
        var price;
        var sets = e.allSeriesPoints;
        for (var p = 0 ; p < sets[0].length; p++) {
          price = {
            open : sets[0][p].yval,
            close : sets[1][p].yval,
            high : sets[2][p].yval,
            low : sets[3][p].yval,
            openY : sets[0][p].y,
            closeY : sets[1][p].y,
            highY : sets[2][p].y,
            lowY : sets[3][p].y
          };
          prices.push(price);
        }

        var area = e.plotArea;
        var ctx = e.drawingContext;
        ctx.strokeStyle = '#202020';
        ctx.lineWidth = 0.6;

        for (p = 0 ; p < prices.length; p++) {
          ctx.beginPath();

          price = prices[p];
          var topY = area.h * price.highY + area.y;
          var bottomY = area.h * price.lowY + area.y;
          var centerX = area.x + sets[0][p].x * area.w;
          ctx.moveTo(centerX, topY);
          ctx.lineTo(centerX, bottomY);
          ctx.closePath();
          ctx.stroke();
          var bodyY;
          if (price.open > price.close) {
            ctx.fillStyle ='rgba(244,44,44,1.0)';
            bodyY = area.h * price.openY + area.y;
          }
          else {
            ctx.fillStyle ='rgba(44,244,44,1.0)';
            bodyY = area.h * price.closeY  + area.y;
          }
          var bodyHeight = area.h * Math.abs(price.openY - price.closeY);
          ctx.fillRect(centerX - BAR_WIDTH / 2, bodyY, BAR_WIDTH,  bodyHeight);
        }

      }

      function legendFormatter(data) {
        
        if (data.x == null) {
          return '';
        }

        var html = this.getLabels()[0] + ': ' + data.xHTML;
        data.series.forEach(function(series) {
          if (!series.isVisible) return;
          var labeledData = series.labelHTML + ': ' + series.yHTML;
          if (series.isHighlighted) {
            labeledData = '<b>' + labeledData + '</b>';
          }
          html += '<br>' + series.dashHTML + ' ' + labeledData;
        });
        return html;
      }

    g2 = new Dygraph(
            document.getElementById("candlechart"),
            data_ohlc,
            {
              plotter: candlePlotter,
              labelsDiv: document.getElementById('legend'),
              legendFormatter: legendFormatter,
              legend: 'follow',
            });
    </script>
</body>
</html>
